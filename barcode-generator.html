<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Barcode Generator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* --------- RESET & VARIABLES --------- */
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      font-family: "Poppins", sans-serif; 
      transition: background-color 0.3s, color 0.3s;
    }

    :root {
      --primary: #38bdf8;
      --primary-dark: #0ea5e9;
      --secondary: #f472b6;
      --accent: #a78bfa;
      --bg: #0f172a;
      --bg-light: #1e293b;
      --bg-lighter: #334155;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --card-bg: rgba(255, 255, 255, 0.05);
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --border: rgba(255, 255, 255, 0.1);
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
    }

    .light-mode {
      --bg: #f8fafc;
      --bg-light: #e2e8f0;
      --bg-lighter: #cbd5e1;
      --text: #0f172a;
      --text-muted: #475569;
      --card-bg: rgba(255, 255, 255, 0.8);
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --border: rgba(0, 0, 0, 0.1);
    }

    body {
      background: linear-gradient(135deg, var(--bg), var(--bg-light));
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background 0.5s ease;
      padding: 0 1rem;
    }

    /* --------- HEADER & NAVIGATION --------- */
    header {
      width: 100%;
      padding: 1.5rem 1rem;
      text-align: center;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      position: relative;
      z-index: 100;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo i {
      font-size: 2.5rem;
      color: var(--primary);
      animation: rotate 10s linear infinite;
    }

    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .logo h1 {
      font-size: 2rem;
      color: var(--primary);
      letter-spacing: 1px;
    }

    .logo p {
      margin-top: 0.5rem;
      color: var(--text-muted);
      font-size: 1rem;
    }

    .theme-toggle {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 50px;
      width: 60px;
      height: 30px;
      position: relative;
      cursor: pointer;
      display: flex;
      align-items: center;
      padding: 0 5px;
      transition: all 0.3s ease;
    }

    .theme-toggle:hover {
      transform: scale(1.05);
    }

    .theme-toggle i {
      position: absolute;
      font-size: 1.2rem;
      transition: all 0.3s ease;
    }

    .theme-toggle .fa-sun {
      color: #f59e0b;
      opacity: 0;
    }

    .theme-toggle .fa-moon {
      color: #94a3b8;
    }

    .light-mode .theme-toggle .fa-sun {
      opacity: 1;
    }

    .light-mode .theme-toggle .fa-moon {
      opacity: 0;
    }

    .theme-toggle::after {
      content: '';
      position: absolute;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--primary);
      transition: all 0.3s ease;
      left: 4px;
    }

    .light-mode .theme-toggle::after {
      left: calc(100% - 26px);
      background: #f59e0b;
    }

    /* --------- MAIN CONTENT --------- */
    .main-content {
      max-width: 1200px;
      width: 100%;
      margin: 2rem auto;
      padding: 0 1rem;
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 2rem;
    }

    @media (max-width: 968px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    .generator-card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 2rem;
      box-shadow: var(--card-shadow);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      margin-bottom: 2rem;
      animation: fadeIn 0.8s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .card-header h2 {
      font-size: 1.8rem;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .card-header p {
      color: var(--text-muted);
    }

    .card-header i {
      font-size: 3rem;
      color: var(--primary);
      margin-bottom: 1rem;
    }

    /* --------- FORM CONTROLS --------- */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text);
    }

    .form-control {
      width: 100%;
      padding: 1rem 1.5rem;
      border: none;
      border-radius: 10px;
      outline: none;
      font-size: 1rem;
      background: var(--bg-light);
      color: var(--text);
      transition: all 0.3s ease;
      border: 1px solid var(--border);
    }

    .form-control:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
    }

    select.form-control {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1rem;
    }

    .input-with-icon {
      position: relative;
    }

    .input-with-icon i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }

    .input-with-icon input {
      padding-left: 3rem;
    }

    /* --------- SIZE CONTROLS --------- */
    .size-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .preset-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .preset-btn {
      padding: 0.5rem;
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
      text-align: center;
    }

    .preset-btn:hover, .preset-btn.active {
      background: var(--primary);
      color: white;
    }

    /* --------- COLOR PICKERS --------- */
    .color-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .color-picker {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .color-input {
      width: 60px;
      height: 40px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: var(--bg-light);
    }

    .color-value {
      font-family: monospace;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    /* --------- OPTIONS SECTION --------- */
    .options-section {
      background: var(--bg-light);
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid var(--border);
    }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .option-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: 8px;
      background: var(--card-bg);
      transition: all 0.3s ease;
    }

    .option-item:hover {
      background: var(--bg-lighter);
      transform: translateY(-2px);
    }

    .option-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }

    .option-item label {
      font-weight: 500;
      color: var(--text);
      cursor: pointer;
      flex: 1;
    }

    /* --------- SLIDER CONTROLS --------- */
    .slider-group {
      margin-bottom: 1rem;
    }

    .slider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .slider-label {
      font-weight: 500;
      color: var(--text);
    }

    .slider-value {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--bg-lighter);
      outline: none;
      -webkit-appearance: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: 2px solid var(--bg);
    }

    .slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: 2px solid var(--bg);
    }

    /* --------- ADVANCED OPTIONS --------- */
    .advanced-section {
      background: var(--bg-light);
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid var(--border);
    }

    .advanced-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .advanced-title {
      font-size: 1.1rem;
      color: var(--primary);
      font-weight: 600;
    }

    .advanced-content {
      margin-top: 1rem;
      display: none;
    }

    .advanced-content.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    /* --------- BUTTONS --------- */
    .button-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .btn {
      padding: 1rem 1.5rem;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-3px);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #0da271;
      transform: translateY(-3px);
    }

    .btn-secondary {
      background: var(--bg-lighter);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-light);
      transform: translateY(-3px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* --------- PREVIEW SECTION --------- */
    .preview-section {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 2rem;
      box-shadow: var(--card-shadow);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      height: fit-content;
      animation: fadeIn 0.8s ease;
    }

    .preview-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .preview-title {
      font-size: 1.2rem;
      color: var(--primary);
      font-weight: 600;
    }

    .preview-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
    }

    .barcode-preview {
      background: white;
      border-radius: 10px;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      width: 100%;
      border: 1px solid var(--border);
    }

    .barcode-svg {
      max-width: 100%;
      height: auto;
    }

    .preview-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      width: 100%;
    }

    .stat-item {
      text-align: center;
      padding: 1rem;
      background: var(--bg-light);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .stat-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .scan-status {
      padding: 0.75rem 1rem;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
    }

    .scan-status.valid {
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid var(--success);
      color: var(--success);
    }

    .scan-status.warning {
      background: rgba(245, 158, 11, 0.2);
      border: 1px solid var(--warning);
      color: var(--warning);
    }

    .scan-status.error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid var(--error);
      color: var(--error);
    }

    /* --------- HISTORY SECTION --------- */
    .history-section {
      margin-top: 2rem;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .history-title {
      font-size: 1.1rem;
      color: var(--primary);
      font-weight: 600;
    }

    .clear-btn {
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem 1rem;
      color: var(--text);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }

    .clear-btn:hover {
      background: var(--error);
      color: white;
    }

    .history-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .history-item {
      background: var(--bg-light);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .history-item:hover {
      background: var(--bg-lighter);
      transform: translateX(5px);
    }

    .history-thumbnail {
      width: 60px;
      height: 40px;
      border-radius: 6px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
    }

    .history-content {
      flex: 1;
      overflow: hidden;
    }

    .history-text {
      font-size: 0.9rem;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 0.25rem;
    }

    .history-meta {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .empty-state {
      text-align: center;
      color: var(--text-muted);
      padding: 2rem;
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* --------- MESSAGE TOAST --------- */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      background: var(--success);
      color: white;
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    /* --------- BACK BUTTON --------- */
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.8rem 1.5rem;
      background: var(--card-bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s ease;
      margin-top: 1rem;
    }

    .back-btn:hover {
      background: var(--primary);
      color: white;
      transform: translateX(-5px);
    }

    /* --------- FOOTER --------- */
    footer {
      padding: 2rem 1rem;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      border-top: 1px solid var(--border);
      width: 100%;
      margin-top: auto;
    }

    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .footer-links {
      display: flex;
      gap: 2rem;
      margin-top: 1rem;
    }

    .footer-links a {
      color: var(--text-muted);
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .footer-links a:hover {
      color: var(--primary);
    }

    /* --------- RESPONSIVE DESIGN --------- */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }

      .button-group {
        grid-template-columns: 1fr;
      }

      .options-grid {
        grid-template-columns: 1fr;
      }

      .color-group {
        grid-template-columns: 1fr;
      }

      .size-controls {
        grid-template-columns: 1fr;
      }

      .preview-stats {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .generator-card, .preview-section {
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <i class="fas fa-toolbox"></i>
        <div>
          <h1>All-in-One Tools</h1>
          <p>50+ useful tools for your everyday needs</p>
        </div>
      </div>
      <div class="theme-toggle" id="themeToggle">
        <i class="fas fa-sun"></i>
        <i class="fas fa-moon"></i>
      </div>
    </div>
  </header>

  <div class="main-content">
    <div class="generator-column">
      <div class="generator-card">
        <div class="card-header">
          <i class="fas fa-barcode"></i>
          <h2>Barcode Generator</h2>
          <p>Create professional barcodes for retail, inventory, and more</p>
        </div>

        <div class="form-group">
          <label for="dataInput">Data / Text <span class="required">*</span></label>
          <div class="input-with-icon">
            <i class="fas fa-text"></i>
            <input type="text" id="dataInput" class="form-control" placeholder="Enter data to encode..." required>
          </div>
          <div id="validationMessage" style="font-size: 0.8rem; margin-top: 0.5rem;"></div>
        </div>

        <div class="form-group">
          <label for="barcodeType">Barcode Type</label>
          <select id="barcodeType" class="form-control">
            <option value="ean13">EAN-13</option>
            <option value="upca">UPC-A</option>
            <option value="code128">Code 128</option>
            <option value="code39">Code 39</option>
            <option value="itf">ITF (Interleaved 2 of 5)</option>
            <option value="gs1128">GS1-128</option>
          </select>
        </div>

        <div class="options-section">
          <h3 style="margin-bottom: 1rem; color: var(--primary);">Format Options</h3>
          <div class="options-grid">
            <div class="option-item">
              <input type="checkbox" id="autoChecksum" checked>
              <label for="autoChecksum">Auto-calculate checksum</label>
            </div>
            <div class="option-item">
              <input type="checkbox" id="forceNumeric">
              <label for="forceNumeric">Force numeric-only</label>
            </div>
            <div class="option-item">
              <input type="checkbox" id="showText" checked>
              <label for="showText">Show human-readable text</label>
            </div>
          </div>

          <div class="form-group">
            <label for="textSize">Text Size</label>
            <input type="range" id="textSize" class="slider" min="8" max="24" value="12">
            <div class="slider-header">
              <span class="slider-label">Font size for human-readable text</span>
              <span class="slider-value" id="textSizeValue">12px</span>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Size & Dimensions</label>
          <div class="size-controls">
            <div>
              <label for="widthInput">Width (px)</label>
              <input type="number" id="widthInput" class="form-control" min="100" max="2000" value="300">
            </div>
            <div>
              <label for="heightInput">Height (px)</label>
              <input type="number" id="heightInput" class="form-control" min="50" max="1000" value="150">
            </div>
          </div>
          <div class="preset-buttons">
            <div class="preset-btn active" data-width="200" data-height="100">Label</div>
            <div class="preset-btn" data-width="300" data-height="150">Shelf Tag</div>
            <div class="preset-btn" data-width="400" data-height="200">A4 Print</div>
            <div class="preset-btn" data-width="600" data-height="300">300 DPI</div>
          </div>
        </div>

        <div class="form-group">
          <label for="scaleInput">Scale / Module Size</label>
          <input type="range" id="scaleInput" class="slider" min="1" max="5" value="2">
          <div class="slider-header">
            <span class="slider-label">Bar width scaling</span>
            <span class="slider-value" id="scaleValue">2px</span>
          </div>
        </div>

        <div class="form-group">
          <label for="marginInput">Margin / Quiet Zone</label>
          <input type="range" id="marginInput" class="slider" min="0" max="40" value="10">
          <div class="slider-header">
            <span class="slider-label">Space around barcode</span>
            <span class="slider-value" id="marginValue">10px</span>
          </div>
        </div>

        <div class="form-group">
          <label for="barHeightRatio">Bar Height Ratio</label>
          <input type="range" id="barHeightRatio" class="slider" min="50" max="95" value="80">
          <div class="slider-header">
            <span class="slider-label">Bar height vs total height</span>
            <span class="slider-value" id="barHeightValue">80%</span>
          </div>
        </div>

        <div class="form-group">
          <label>Colors</label>
          <div class="color-group">
            <div class="color-picker">
              <input type="color" id="fgColor" class="color-input" value="#000000">
              <span class="color-value" id="fgColorValue">#000000</span>
              <span>Foreground</span>
            </div>
            <div class="color-picker">
              <input type="color" id="bgColor" class="color-input" value="#ffffff">
              <span class="color-value" id="bgColorValue">#FFFFFF</span>
              <span>Background</span>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="outputFormat">Output Format</label>
          <select id="outputFormat" class="form-control">
            <option value="svg">SVG (Vector)</option>
            <option value="png">PNG (Raster)</option>
          </select>
        </div>

        <div class="advanced-section">
          <div class="advanced-header" id="advancedToggle">
            <div class="advanced-title">Advanced Options</div>
            <i class="fas fa-chevron-down" id="advancedIcon"></i>
          </div>
          <div class="advanced-content" id="advancedContent">
            <div class="options-grid">
              <div class="option-item">
                <input type="checkbox" id="bearerBars">
                <label for="bearerBars">Add bearer bars (EAN/UPC)</label>
              </div>
              <div class="option-item">
                <input type="checkbox" id="monochrome">
                <label for="monochrome">Monochrome for print</label>
              </div>
              <div class="option-item">
                <input type="checkbox" id="enforceQuietZone" checked>
                <label for="enforceQuietZone">Enforce quiet zone</label>
              </div>
            </div>

            <div class="form-group">
              <label for="dpiSelect">DPI for Export</label>
              <select id="dpiSelect" class="form-control">
                <option value="72">72 DPI (Screen)</option>
                <option value="150">150 DPI (Basic Print)</option>
                <option value="300" selected>300 DPI (High Quality)</option>
                <option value="600">600 DPI (Professional)</option>
              </select>
            </div>
          </div>
        </div>

        <div class="button-group">
          <button class="btn btn-primary" id="generateBtn">
            <i class="fas fa-bolt"></i> Generate Barcode
          </button>
          <button class="btn btn-success" id="downloadBtn" disabled>
            <i class="fas fa-download"></i> Download
          </button>
          <button class="btn btn-success" id="copyBtn" disabled>
            <i class="fas fa-copy"></i> Copy Image
          </button>
          <button class="btn btn-secondary" id="copyDataBtn" disabled>
            <i class="fas fa-code"></i> Copy Data URI
          </button>
          <button class="btn btn-secondary" id="resetBtn">
            <i class="fas fa-redo"></i> Reset
          </button>
          <button class="btn btn-secondary" id="clearPrefsBtn">
            <i class="fas fa-trash"></i> Clear Preferences
          </button>
        </div>

        <a href="index.html" class="back-btn">
          <i class="fas fa-arrow-left"></i> Back to Home
        </a>
      </div>
    </div>

    <div class="preview-section">
      <div class="preview-header">
        <div class="preview-title">Barcode Preview</div>
      </div>

      <div class="preview-container">
        <div class="barcode-preview">
          <svg id="barcodeSvg" class="barcode-svg" width="300" height="150" viewBox="0 0 300 150"></svg>
        </div>

        <div class="preview-stats">
          <div class="stat-item">
            <div class="stat-value" id="typeStat">EAN-13</div>
            <div class="stat-label">Type</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="sizeStat">300×150</div>
            <div class="stat-label">Size</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="checksumStat">-</div>
            <div class="stat-label">Checksum</div>
          </div>
        </div>

        <div class="scan-status" id="scanStatus">
          <i class="fas fa-info-circle"></i> Generate a barcode to test scannability
        </div>

        <div class="button-group">
          <button class="btn btn-success" id="previewDownloadBtn" disabled>
            <i class="fas fa-download"></i> Download
          </button>
          <button class="btn btn-success" id="previewCopyBtn" disabled>
            <i class="fas fa-copy"></i> Copy
          </button>
        </div>
      </div>

      <div class="history-section">
        <div class="history-header">
          <div class="history-title">Recent Barcodes</div>
          <button class="clear-btn" id="clearHistoryBtn">
            <i class="fas fa-trash"></i> Clear
          </button>
        </div>
        <div class="history-list" id="historyList">
          <div class="empty-state">
            <i class="fas fa-history"></i>
            <p>No generation history yet</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <p>© 2025 Prabin's Toolbox | All Rights Reserved</p>
      <div class="footer-links">
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Service</a>
        <a href="#">Contact Us</a>
      </div>
    </div>
  </footer>

  <div class="toast" id="copyToast">
    <i class="fas fa-check-circle"></i>
    <span>Barcode copied to clipboard!</span>
  </div>

  <script>
    // Security note: All barcode generation and processing happens client-side only.
    // No data is transmitted to any server - everything remains on your device.

    // ---------- DOM ELEMENTS ----------
    const dataInput = document.getElementById('dataInput');
    const validationMessage = document.getElementById('validationMessage');
    const barcodeType = document.getElementById('barcodeType');
    const autoChecksum = document.getElementById('autoChecksum');
    const forceNumeric = document.getElementById('forceNumeric');
    const showText = document.getElementById('showText');
    const textSize = document.getElementById('textSize');
    const textSizeValue = document.getElementById('textSizeValue');
    const widthInput = document.getElementById('widthInput');
    const heightInput = document.getElementById('heightInput');
    const scaleInput = document.getElementById('scaleInput');
    const scaleValue = document.getElementById('scaleValue');
    const marginInput = document.getElementById('marginInput');
    const marginValue = document.getElementById('marginValue');
    const barHeightRatio = document.getElementById('barHeightRatio');
    const barHeightValue = document.getElementById('barHeightValue');
    const fgColor = document.getElementById('fgColor');
    const fgColorValue = document.getElementById('fgColorValue');
    const bgColor = document.getElementById('bgColor');
    const bgColorValue = document.getElementById('bgColorValue');
    const outputFormat = document.getElementById('outputFormat');
    const bearerBars = document.getElementById('bearerBars');
    const monochrome = document.getElementById('monochrome');
    const enforceQuietZone = document.getElementById('enforceQuietZone');
    const dpiSelect = document.getElementById('dpiSelect');
    const advancedToggle = document.getElementById('advancedToggle');
    const advancedContent = document.getElementById('advancedContent');
    const advancedIcon = document.getElementById('advancedIcon');
    const generateBtn = document.getElementById('generateBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const copyBtn = document.getElementById('copyBtn');
    const copyDataBtn = document.getElementById('copyDataBtn');
    const resetBtn = document.getElementById('resetBtn');
    const clearPrefsBtn = document.getElementById('clearPrefsBtn');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    const barcodeSvg = document.getElementById('barcodeSvg');
    const typeStat = document.getElementById('typeStat');
    const sizeStat = document.getElementById('sizeStat');
    const checksumStat = document.getElementById('checksumStat');
    const scanStatus = document.getElementById('scanStatus');
    const previewDownloadBtn = document.getElementById('previewDownloadBtn');
    const previewCopyBtn = document.getElementById('previewCopyBtn');
    const historyList = document.getElementById('historyList');
    const copyToast = document.getElementById('copyToast');
    const presetButtons = document.querySelectorAll('.preset-btn');

    // ---------- STATE VARIABLES ----------
    let currentBarcode = null;
    let generationHistory = [];

    // ---------- BARCODE ENCODING TABLES ----------
    const barcodeEncodings = {
      // EAN-13 encoding patterns (left-hand digits)
      ean13: {
        patterns: {
          '0': '0001101', '1': '0011001', '2': '0010011', '3': '0111101', '4': '0100011',
          '5': '0110001', '6': '0101111', '7': '0111011', '8': '0110111', '9': '0001011'
        },
        firstDigitPatterns: {
          '0': 'LLLLLL', '1': 'LLGLGG', '2': 'LLGGLG', '3': 'LLGGGL', '4': 'LGLLGG',
          '5': 'LGGLLG', '6': 'LGGGLL', '7': 'LGLGLG', '8': 'LGLGGL', '9': 'LGGLGL'
        }
      },

      // UPC-A is essentially EAN-13 without the first digit
      upca: {
        patterns: {
          '0': '0001101', '1': '0011001', '2': '0010011', '3': '0111101', '4': '0100011',
          '5': '0110001', '6': '0101111', '7': '0111011', '8': '0110111', '9': '0001011'
        }
      },

      // Code 39 encoding (each character is 9 bars: 5 black, 4 white)
      code39: {
        patterns: {
          '0': '101001101101', '1': '110100101011', '2': '101100101011', '3': '110110010101',
          '4': '101001101011', '5': '110100110101', '6': '101100110101', '7': '101001011011',
          '8': '110100101101', '9': '101100101101', 'A': '110101001011', 'B': '101101001011',
          'C': '110110100101', 'D': '101011001011', 'E': '110101100101', 'F': '101101100101',
          'G': '101010011011', 'H': '110101001101', 'I': '101101001101', 'J': '101011001101',
          'K': '110101010011', 'L': '101101010011', 'M': '110110101001', 'N': '101011010011',
          'O': '110101101001', 'P': '101101101001', 'Q': '101010110011', 'R': '110101011001',
          'S': '101101011001', 'T': '101011011001', 'U': '110010101011', 'V': '100110101011',
          'W': '110011010101', 'X': '100101101011', 'Y': '110010110101', 'Z': '100110110101',
          '-': '100101011011', '.': '110010101101', ' ': '100110101101', '$': '100100100101',
          '/': '100100101001', '+': '100101001001', '%': '101001001001', '*': '100101101101'
        }
      },

      // ITF encoding (2 digits per pattern)
      itf: {
        patterns: {
          '00': '00110', '01': '10001', '02': '01001', '03': '11000', '04': '00101',
          '05': '10100', '06': '01100', '07': '00011', '08': '10010', '09': '01010',
          '10': '00001', '11': '10000', '12': '01000', '13': '11001', '14': '00100',
          '15': '10101', '16': '01101', '17': '00010', '18': '10011', '19': '01011',
          '20': '00111', '21': '10110', '22': '01110', '23': '10111', '24': '11010',
          '25': '11011', '26': '11100', '27': '11101', '28': '11110', '29': '10110',
          '30': '01001', '31': '11000', '32': '00101', '33': '10100', '34': '01100',
          '35': '00011', '36': '10010', '37': '01010', '38': '00110', '39': '10001',
          '40': '00111', '41': '10110', '42': '01110', '43': '10111', '44': '11010',
          '45': '11011', '46': '11100', '47': '11101', '48': '11110', '49': '10110'
        }
      }
    };

    // ---------- INITIALIZATION ----------
    function initializeGenerator() {
      // Load saved preferences and history
      loadPreferences();
      loadHistory();
      
      // Set up event listeners
      setupEventListeners();
      
      // Initial UI update
      updateTextSizeValue();
      updateScaleValue();
      updateMarginValue();
      updateBarHeightValue();
      updateColorValues();
      
      // Generate initial barcode if there's data
      if (dataInput.value) {
        generateBarcode();
      }
    }

    function setupEventListeners() {
      // Input events
      dataInput.addEventListener('input', validateInput);
      barcodeType.addEventListener('change', handleBarcodeTypeChange);
      textSize.addEventListener('input', updateTextSizeValue);
      scaleInput.addEventListener('input', updateScaleValue);
      marginInput.addEventListener('input', updateMarginValue);
      barHeightRatio.addEventListener('input', updateBarHeightValue);
      fgColor.addEventListener('input', updateColorValues);
      bgColor.addEventListener('input', updateColorValues);
      
      // Option events
      autoChecksum.addEventListener('change', handleOptionChange);
      forceNumeric.addEventListener('change', handleOptionChange);
      showText.addEventListener('change', handleOptionChange);
      bearerBars.addEventListener('change', handleOptionChange);
      monochrome.addEventListener('change', handleOptionChange);
      enforceQuietZone.addEventListener('change', handleOptionChange);
      dpiSelect.addEventListener('change', handleOptionChange);
      outputFormat.addEventListener('change', handleOptionChange);
      
      // Size preset buttons
      presetButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          presetButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          widthInput.value = btn.dataset.width;
          heightInput.value = btn.dataset.height;
          if (currentBarcode) generateBarcode();
        });
      });
      
      // Button events
      generateBtn.addEventListener('click', generateBarcode);
      downloadBtn.addEventListener('click', downloadBarcode);
      copyBtn.addEventListener('click', copyBarcode);
      copyDataBtn.addEventListener('click', copyDataURI);
      resetBtn.addEventListener('click', resetSettings);
      clearPrefsBtn.addEventListener('click', clearPreferences);
      clearHistoryBtn.addEventListener('click', clearHistory);
      previewDownloadBtn.addEventListener('click', downloadBarcode);
      previewCopyBtn.addEventListener('click', copyBarcode);
      
      // Advanced options toggle
      advancedToggle.addEventListener('click', toggleAdvancedOptions);
    }

    // ---------- INPUT VALIDATION ----------
    function validateInput() {
      const data = dataInput.value.trim();
      const type = barcodeType.value;
      let message = '';
      let isValid = true;

      switch (type) {
        case 'ean13':
          if (!/^\d+$/.test(data)) {
            message = 'EAN-13 requires only digits (0-9)';
            isValid = false;
          } else if (data.length === 12 && autoChecksum.checked) {
            message = '12 digits provided - checksum will be calculated';
          } else if (data.length === 13 && autoChecksum.checked) {
            message = '13 digits provided - checksum will be validated';
          } else if (data.length < 12 || data.length > 13) {
            message = 'EAN-13 requires 12 or 13 digits';
            isValid = false;
          }
          break;

        case 'upca':
          if (!/^\d+$/.test(data)) {
            message = 'UPC-A requires only digits (0-9)';
            isValid = false;
          } else if (data.length === 11 && autoChecksum.checked) {
            message = '11 digits provided - checksum will be calculated';
          } else if (data.length === 12 && autoChecksum.checked) {
            message = '12 digits provided - checksum will be validated';
          } else if (data.length < 11 || data.length > 12) {
            message = 'UPC-A requires 11 or 12 digits';
            isValid = false;
          }
          break;

        case 'code39':
          if (!/^[A-Z0-9\-\.\ \$\/\+\%]+$/i.test(data)) {
            message = 'Code 39 supports A-Z, 0-9, and - . $ / + % space';
            isValid = false;
          }
          break;

        case 'itf':
          if (!/^\d+$/.test(data)) {
            message = 'ITF requires only digits (0-9)';
            isValid = false;
          } else if (data.length % 2 !== 0 && autoChecksum.checked) {
            message = 'ITF requires even number of digits - will pad with leading zero';
          }
          break;

        case 'gs1128':
          // GS1-128 can contain various characters
          if (data.length === 0) {
            message = 'GS1-128 requires data';
            isValid = false;
          }
          break;

        case 'code128':
          // Code 128 supports full ASCII
          if (data.length === 0) {
            message = 'Code 128 requires data';
            isValid = false;
          }
          break;
      }

      validationMessage.textContent = message;
      validationMessage.style.color = isValid ? 'var(--success)' : 'var(--error)';
      
      return isValid;
    }

    function handleBarcodeTypeChange() {
      const type = barcodeType.value;
      
      // Show/hide format-specific options
      const showChecksum = ['ean13', 'upca', 'itf'].includes(type);
      autoChecksum.parentElement.style.display = showChecksum ? 'flex' : 'none';
      
      const showNumeric = ['ean13', 'upca', 'itf'].includes(type);
      forceNumeric.parentElement.style.display = showNumeric ? 'flex' : 'none';
      
      const showBearer = ['ean13', 'upca'].includes(type);
      bearerBars.parentElement.style.display = showBearer ? 'flex' : 'none';
      
      // Update validation
      validateInput();
      
      if (currentBarcode) {
        generateBarcode();
      }
    }

    // ---------- BARCODE GENERATION ----------
    function generateBarcode() {
      const data = dataInput.value.trim();
      
      if (!data) {
        showStatus('Please enter data to encode', 'error');
        return;
      }
      
      if (!validateInput()) {
        showStatus('Invalid input for selected barcode type', 'error');
        return;
      }
      
      try {
        const type = barcodeType.value;
        const width = parseInt(widthInput.value);
        const height = parseInt(heightInput.value);
        const scale = parseInt(scaleInput.value);
        const margin = parseInt(marginInput.value);
        const barHeightPct = parseInt(barHeightRatio.value) / 100;
        const fg = fgColor.value;
        const bg = bgColor.value;
        const textSizeVal = parseInt(textSize.value);
        
        // Process data based on barcode type
        const processedData = processData(data, type);
        
        // Generate barcode pattern
        const pattern = generateBarcodePattern(processedData, type);
        
        // Render barcode
        renderBarcode(pattern, width, height, scale, margin, barHeightPct, fg, bg, textSizeVal, processedData);
        
        // Update stats and UI
        updateStats(type, width, height, processedData);
        updateScanStatus(pattern, type);
        enableOutputButtons();
        
        // Add to history
        addToHistory(data, type, pattern, width, height);
        
        // Save preferences
        savePreferences();
        
        showStatus('Barcode generated successfully', 'success');
      } catch (error) {
        showStatus(`Error generating barcode: ${error.message}`, 'error');
        console.error('Barcode generation error:', error);
      }
    }

    function processData(data, type) {
      let processed = data;
      
      switch (type) {
        case 'ean13':
          if (autoChecksum.checked) {
            if (processed.length === 12) {
              processed += calculateEAN13Checksum(processed);
            } else if (processed.length === 13) {
              const checksum = calculateEAN13Checksum(processed.substring(0, 12));
              if (checksum !== parseInt(processed[12])) {
                showStatus('EAN-13 checksum validation failed', 'warning');
              }
            }
          }
          break;

        case 'upca':
          if (autoChecksum.checked) {
            if (processed.length === 11) {
              processed += calculateUPCAChecksum(processed);
            } else if (processed.length === 12) {
              const checksum = calculateUPCAChecksum(processed.substring(0, 11));
              if (checksum !== parseInt(processed[11])) {
                showStatus('UPC-A checksum validation failed', 'warning');
              }
            }
          }
          break;

        case 'itf':
          if (autoChecksum.checked) {
            // Add checksum digit for ITF
            processed = processed.padStart(processed.length % 2 === 0 ? processed.length : processed.length + 1, '0');
            const checksum = calculateITFChecksum(processed);
            processed += checksum.toString();
          } else {
            // Ensure even number of digits
            processed = processed.padStart(processed.length % 2 === 0 ? processed.length : processed.length + 1, '0');
          }
          break;

        case 'code39':
          // Add start/stop characters if not present
          if (!processed.startsWith('*')) processed = '*' + processed;
          if (!processed.endsWith('*')) processed += '*';
          break;

        case 'gs1128':
          // Add FNC1 character for GS1-128
          processed = String.fromCharCode(241) + processed;
          break;
      }
      
      return processed;
    }

    function generateBarcodePattern(data, type) {
      switch (type) {
        case 'ean13':
          return generateEAN13Pattern(data);
        case 'upca':
          return generateUPCAPattern(data);
        case 'code39':
          return generateCode39Pattern(data);
        case 'itf':
          return generateITFPattern(data);
        case 'code128':
          return generateCode128Pattern(data);
        case 'gs1128':
          return generateCode128Pattern(data); // GS1-128 uses Code 128 with FNC1
        default:
          throw new Error(`Unsupported barcode type: ${type}`);
      }
    }

    function generateEAN13Pattern(data) {
      const pattern = ['101']; // Start pattern
      
      const firstDigit = data[0];
      const encodingPattern = barcodeEncodings.ean13.firstDigitPatterns[firstDigit];
      
      // Encode left-hand digits
      for (let i = 1; i <= 6; i++) {
        const digit = data[i];
        const digitPattern = barcodeEncodings.ean13.patterns[digit];
        
        // Apply L/G encoding based on first digit pattern
        if (encodingPattern[i - 1] === 'L') {
          pattern.push(digitPattern);
        } else {
          // G pattern is inverse of L pattern
          pattern.push(digitPattern.split('').map(bit => bit === '0' ? '1' : '0').join(''));
        }
      }
      
      pattern.push('01010'); // Center pattern
      
      // Encode right-hand digits (always R pattern)
      for (let i = 7; i <= 12; i++) {
        const digit = data[i];
        const digitPattern = barcodeEncodings.ean13.patterns[digit];
        pattern.push(digitPattern.split('').map(bit => bit === '0' ? '1' : '0').join(''));
      }
      
      pattern.push('101'); // End pattern
      
      return pattern.join('');
    }

    function generateUPCAPattern(data) {
      // UPC-A is EAN-13 without the first digit
      const pattern = ['101']; // Start pattern
      
      // Left-hand digits (first 6, always L pattern)
      for (let i = 0; i < 6; i++) {
        const digit = data[i];
        pattern.push(barcodeEncodings.upca.patterns[digit]);
      }
      
      pattern.push('01010'); // Center pattern
      
      // Right-hand digits (last 6, always R pattern)
      for (let i = 6; i < 12; i++) {
        const digit = data[i];
        const digitPattern = barcodeEncodings.upca.patterns[digit];
        pattern.push(digitPattern.split('').map(bit => bit === '0' ? '1' : '0').join(''));
      }
      
      pattern.push('101'); // End pattern
      
      return pattern.join('');
    }

    function generateCode39Pattern(data) {
      let pattern = '';
      
      for (let i = 0; i < data.length; i++) {
        const char = data[i].toUpperCase();
        if (barcodeEncodings.code39.patterns[char]) {
          pattern += barcodeEncodings.code39.patterns[char];
          // Add inter-character gap (narrow space)
          if (i < data.length - 1) pattern += '0';
        }
      }
      
      return pattern;
    }

    function generateITFPattern(data) {
      let pattern = '1010'; // Start pattern
      
      // Process digits in pairs
      for (let i = 0; i < data.length; i += 2) {
        const pair = data.substring(i, i + 2);
        if (barcodeEncodings.itf.patterns[pair]) {
          const pairPattern = barcodeEncodings.itf.patterns[pair];
          
          // Interleave the pattern (bars for first digit, spaces for second)
          for (let j = 0; j < 5; j++) {
            const barWidth = pairPattern[j] === '0' ? '1' : '2'; // 1=narrow, 2=wide
            const spaceWidth = pairPattern[j] === '0' ? '1' : '2';
            pattern += barWidth + '0' + spaceWidth + '0';
          }
        }
      }
      
      pattern += '1101'; // End pattern
      return pattern;
    }

    function generateCode128Pattern(data) {
      // Simplified Code 128 implementation
      // In a real implementation, this would use proper code sets and switching
      let pattern = '11010010000'; // Start code B
      
      // Basic encoding - each character adds 11 bits
      for (let i = 0; i < data.length; i++) {
        const charCode = data.charCodeAt(i);
        // Simplified pattern for demonstration
        pattern += charCode.toString(2).padStart(11, '0');
      }
      
      // Add checksum (simplified)
      let checksum = 104; // Start code B value
      for (let i = 0; i < data.length; i++) {
        checksum += (i + 1) * data.charCodeAt(i);
      }
      checksum = checksum % 103;
      pattern += checksum.toString(2).padStart(11, '0');
      
      pattern += '1100011101011'; // Stop pattern
      
      return pattern;
    }

    // ---------- CHECKSUM CALCULATIONS ----------
    function calculateEAN13Checksum(data) {
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        const digit = parseInt(data[i]);
        sum += (i % 2 === 0) ? digit : digit * 3;
      }
      return (10 - (sum % 10)) % 10;
    }

    function calculateUPCAChecksum(data) {
      let sum = 0;
      for (let i = 0; i < 11; i++) {
        const digit = parseInt(data[i]);
        sum += (i % 2 === 0) ? digit * 3 : digit;
      }
      return (10 - (sum % 10)) % 10;
    }

    function calculateITFChecksum(data) {
      let sum = 0;
      for (let i = 0; i < data.length; i++) {
        const digit = parseInt(data[i]);
        sum += (i % 2 === 0) ? digit * 3 : digit;
      }
      return (10 - (sum % 10)) % 10;
    }

    // ---------- RENDERING ----------
    function renderBarcode(pattern, width, height, scale, margin, barHeightPct, fg, bg, textSize, data) {
      const svg = barcodeSvg;
      svg.innerHTML = '';
      svg.setAttribute('width', width);
      svg.setAttribute('height', height);
      svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
      
      // Background
      const bgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      bgRect.setAttribute('width', '100%');
      bgRect.setAttribute('height', '100%');
      bgRect.setAttribute('fill', bg);
      svg.appendChild(bgRect);
      
      // Calculate dimensions
      const barHeight = height * barHeightPct;
      const textAreaHeight = height - barHeight;
      const contentWidth = width - (margin * 2);
      const moduleWidth = contentWidth / pattern.length;
      
      let x = margin;
      
      // Draw bars
      for (let i = 0; i < pattern.length; i++) {
        const bit = pattern[i];
        if (bit === '1' || bit === '2') {
          const barWidth = moduleWidth * (bit === '2' ? 2 : 1);
          const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          rect.setAttribute('x', x);
          rect.setAttribute('y', margin);
          rect.setAttribute('width', barWidth);
          rect.setAttribute('height', barHeight - (margin * 2));
          rect.setAttribute('fill', fg);
          svg.appendChild(rect);
        }
        x += moduleWidth * (bit === '2' ? 2 : 1);
      }
      
      // Add human-readable text
      if (showText.checked) {
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', width / 2);
        text.setAttribute('y', barHeight + (textAreaHeight / 2) + (textSize / 3));
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('font-family', 'monospace');
        text.setAttribute('font-size', textSize);
        text.setAttribute('fill', fg);
        text.textContent = data;
        svg.appendChild(text);
      }
      
      // Add bearer bars for EAN/UPC if enabled
      if (bearerBars.checked && ['ean13', 'upca'].includes(barcodeType.value)) {
        const bearerWidth = 2;
        const topBearer = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        topBearer.setAttribute('x', margin);
        topBearer.setAttribute('y', margin);
        topBearer.setAttribute('width', contentWidth);
        topBearer.setAttribute('height', bearerWidth);
        topBearer.setAttribute('fill', fg);
        svg.appendChild(topBearer);
        
        const bottomBearer = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        bottomBearer.setAttribute('x', margin);
        bottomBearer.setAttribute('y', barHeight - margin - bearerWidth);
        bottomBearer.setAttribute('width', contentWidth);
        bottomBearer.setAttribute('height', bearerWidth);
        bottomBearer.setAttribute('fill', fg);
        svg.appendChild(bottomBearer);
      }
      
      currentBarcode = {
        pattern: pattern,
        data: data,
        width: width,
        height: height,
        type: barcodeType.value
      };
    }

    // ---------- UTILITY FUNCTIONS ----------
    function updateTextSizeValue() {
      textSizeValue.textContent = `${textSize.value}px`;
    }

    function updateScaleValue() {
      scaleValue.textContent = `${scaleInput.value}px`;
    }

    function updateMarginValue() {
      marginValue.textContent = `${marginInput.value}px`;
    }

    function updateBarHeightValue() {
      barHeightValue.textContent = `${barHeightRatio.value}%`;
    }

    function updateColorValues() {
      fgColorValue.textContent = fgColor.value.toUpperCase();
      bgColorValue.textContent = bgColor.value.toUpperCase();
    }

    function handleOptionChange() {
      if (currentBarcode) {
        generateBarcode();
      }
    }

    function toggleAdvancedOptions() {
      advancedContent.classList.toggle('active');
      advancedIcon.className = advancedContent.classList.contains('active') 
        ? 'fas fa-chevron-up' 
        : 'fas fa-chevron-down';
    }

    function updateStats(type, width, height, data) {
      typeStat.textContent = type.toUpperCase();
      sizeStat.textContent = `${width}×${height}`;
      
      // Show checksum if applicable
      if (['ean13', 'upca', 'itf'].includes(type) && autoChecksum.checked) {
        checksumStat.textContent = data[data.length - 1];
      } else {
        checksumStat.textContent = '-';
      }
    }

    function updateScanStatus(pattern, type) {
      // Basic scanability check
      const minQuietZone = enforceQuietZone.checked ? 10 : 5;
      const currentMargin = parseInt(marginInput.value);
      
      if (currentMargin < minQuietZone) {
        scanStatus.className = 'scan-status warning';
        scanStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Quiet zone may be too small (${currentMargin}px < ${minQuietZone}px)`;
      } else if (pattern.length < 20) {
        scanStatus.className = 'scan-status warning';
        scanStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Barcode may be too short for reliable scanning';
      } else {
        scanStatus.className = 'scan-status valid';
        scanStatus.innerHTML = '<i class="fas fa-check-circle"></i> Should scan reliably';
      }
    }

    function enableOutputButtons() {
      downloadBtn.disabled = false;
      copyBtn.disabled = false;
      copyDataBtn.disabled = false;
      previewDownloadBtn.disabled = false;
      previewCopyBtn.disabled = false;
    }

    // ---------- OUTPUT FUNCTIONS ----------
    function downloadBarcode() {
      if (!currentBarcode) return;
      
      const format = outputFormat.value;
      const width = parseInt(widthInput.value);
      const height = parseInt(heightInput.value);
      const type = barcodeType.value;
      const data = dataInput.value.trim().substring(0, 20).replace(/[^a-zA-Z0-9]/g, '_');
      const timestamp = new Date().toISOString().split('T')[0];
      
      let filename = `barcode_${type}_${data}_${timestamp}`;
      let dataUrl;
      
      if (format === 'svg') {
        dataUrl = 'data:image/svg+xml;base64,' + btoa(barcodeSvg.outerHTML);
        filename += '.svg';
      } else {
        // Convert SVG to PNG using canvas
        const canvas = document.createElement('canvas');
        const dpi = parseInt(dpiSelect.value);
        const scale = dpi / 72; // 72 is standard screen DPI
        
        canvas.width = width * scale;
        canvas.height = height * scale;
        const ctx = canvas.getContext('2d');
        
        // Draw white background
        ctx.fillStyle = bgColor.value;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Create image from SVG
        const svgBlob = new Blob([barcodeSvg.outerHTML], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(svgBlob);
        const img = new Image();
        
        img.onload = function() {
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          dataUrl = canvas.toDataURL('image/png');
          
          const link = document.createElement('a');
          link.href = dataUrl;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          
          showStatus('Barcode downloaded', 'success');
        };
        
        img.src = url;
        return; // Exit early for PNG
      }
      
      const link = document.createElement('a');
      link.href = dataUrl;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showStatus('Barcode downloaded', 'success');
    }

    function copyBarcode() {
      if (!currentBarcode) return;
      
      const canvas = document.createElement('canvas');
      canvas.width = currentBarcode.width;
      canvas.height = currentBarcode.height;
      const ctx = canvas.getContext('2d');
      
      // Draw white background
      ctx.fillStyle = bgColor.value;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Create image from SVG
      const svgBlob = new Blob([barcodeSvg.outerHTML], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(svgBlob);
      const img = new Image();
      
      img.onload = function() {
        ctx.drawImage(img, 0, 0);
        canvas.toBlob(blob => {
          const item = new ClipboardItem({ 'image/png': blob });
          navigator.clipboard.write([item]).then(() => {
            copyToast.classList.add('show');
            setTimeout(() => {
              copyToast.classList.remove('show');
            }, 3000);
          }).catch(err => {
            showStatus('Failed to copy image to clipboard', 'error');
            console.error('Copy error:', err);
          });
          URL.revokeObjectURL(url);
        });
      };
      
      img.src = url;
    }

    function copyDataURI() {
      if (!currentBarcode) return;
      
      const format = outputFormat.value;
      let dataUrl;
      
      if (format === 'svg') {
        dataUrl = 'data:image/svg+xml;base64,' + btoa(barcodeSvg.outerHTML);
      } else {
        const canvas = document.createElement('canvas');
        canvas.width = currentBarcode.width;
        canvas.height = currentBarcode.height;
        const ctx = canvas.getContext('2d');
        
        // Draw white background
        ctx.fillStyle = bgColor.value;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Create image from SVG
        const svgBlob = new Blob([barcodeSvg.outerHTML], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(svgBlob);
        const img = new Image();
        
        img.onload = function() {
          ctx.drawImage(img, 0, 0);
          dataUrl = canvas.toDataURL('image/png');
          navigator.clipboard.writeText(dataUrl).then(() => {
            showStatus('Data URL copied to clipboard', 'success');
          }).catch(err => {
            showStatus('Failed to copy data URL', 'error');
            console.error('Copy error:', err);
          });
          URL.revokeObjectURL(url);
        };
        
        img.src = url;
        return; // Exit early for PNG
      }
      
      navigator.clipboard.writeText(dataUrl).then(() => {
        showStatus('Data URL copied to clipboard', 'success');
      }).catch(err => {
        showStatus('Failed to copy data URL', 'error');
        console.error('Copy error:', err);
      });
    }

    // ---------- HISTORY MANAGEMENT ----------
    function addToHistory(data, type, pattern, width, height) {
      const historyItem = {
        id: Date.now(),
        data: data,
        type: type,
        pattern: pattern,
        width: width,
        height: height,
        timestamp: new Date().toISOString(),
        fgColor: fgColor.value,
        bgColor: bgColor.value
      };
      
      generationHistory.unshift(historyItem);
      generationHistory = generationHistory.slice(0, 10); // Keep only last 10
      
      saveHistory();
      renderHistory();
    }

    function renderHistory() {
      if (generationHistory.length === 0) {
        historyList.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-history"></i>
            <p>No generation history yet</p>
          </div>
        `;
        return;
      }
      
      historyList.innerHTML = '';
      
      generationHistory.forEach(item => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        
        // Create thumbnail (simplified representation)
        historyItem.innerHTML = `
          <div class="history-thumbnail" style="background: ${item.bgColor};">
            <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
              <div style="font-size: 0.6rem; color: ${item.fgColor}; font-weight: bold;">${item.type}</div>
            </div>
          </div>
          <div class="history-content">
            <div class="history-text">${item.data}</div>
            <div class="history-meta">${item.type.toUpperCase()} • ${item.width}×${item.height} • ${new Date(item.timestamp).toLocaleDateString()}</div>
          </div>
        `;
        
        historyItem.addEventListener('click', () => loadFromHistory(item));
        historyList.appendChild(historyItem);
      });
    }

    function loadFromHistory(item) {
      dataInput.value = item.data;
      barcodeType.value = item.type;
      widthInput.value = item.width;
      heightInput.value = item.height;
      fgColor.value = item.fgColor;
      bgColor.value = item.bgColor;
      updateColorValues();
      handleBarcodeTypeChange();
      generateBarcode();
    }

    function clearHistory() {
      if (confirm('Are you sure you want to clear all history?')) {
        generationHistory = [];
        saveHistory();
        renderHistory();
        showStatus('History cleared', 'info');
      }
    }

    function saveHistory() {
      localStorage.setItem('barcodeHistory', JSON.stringify(generationHistory));
    }

    function loadHistory() {
      const saved = localStorage.getItem('barcodeHistory');
      if (saved) {
        try {
          generationHistory = JSON.parse(saved);
          renderHistory();
        } catch (e) {
          console.error('Error loading history:', e);
        }
      }
    }

    // ---------- PREFERENCE MANAGEMENT ----------
    function savePreferences() {
      const preferences = {
        data: dataInput.value,
        type: barcodeType.value,
        autoChecksum: autoChecksum.checked,
        forceNumeric: forceNumeric.checked,
        showText: showText.checked,
        textSize: textSize.value,
        width: widthInput.value,
        height: heightInput.value,
        scale: scaleInput.value,
        margin: marginInput.value,
        barHeightRatio: barHeightRatio.value,
        fgColor: fgColor.value,
        bgColor: bgColor.value,
        outputFormat: outputFormat.value,
        bearerBars: bearerBars.checked,
        monochrome: monochrome.checked,
        enforceQuietZone: enforceQuietZone.checked,
        dpi: dpiSelect.value
      };
      
      localStorage.setItem('barcodePreferences', JSON.stringify(preferences));
    }

    function loadPreferences() {
      const saved = localStorage.getItem('barcodePreferences');
      
      if (saved) {
        try {
          const preferences = JSON.parse(saved);
          
          dataInput.value = preferences.data || '';
          barcodeType.value = preferences.type || 'ean13';
          autoChecksum.checked = preferences.autoChecksum !== false;
          forceNumeric.checked = preferences.forceNumeric || false;
          showText.checked = preferences.showText !== false;
          textSize.value = preferences.textSize || '12';
          widthInput.value = preferences.width || '300';
          heightInput.value = preferences.height || '150';
          scaleInput.value = preferences.scale || '2';
          marginInput.value = preferences.margin || '10';
          barHeightRatio.value = preferences.barHeightRatio || '80';
          fgColor.value = preferences.fgColor || '#000000';
          bgColor.value = preferences.bgColor || '#ffffff';
          outputFormat.value = preferences.outputFormat || 'svg';
          bearerBars.checked = preferences.bearerBars || false;
          monochrome.checked = preferences.monochrome || false;
          enforceQuietZone.checked = preferences.enforceQuietZone !== false;
          dpiSelect.value = preferences.dpi || '300';
          
          // Update UI
          updateTextSizeValue();
          updateScaleValue();
          updateMarginValue();
          updateBarHeightValue();
          updateColorValues();
          handleBarcodeTypeChange();
        } catch (e) {
          console.error('Error loading preferences:', e);
        }
      }
    }

    function clearPreferences() {
      if (confirm('Are you sure you want to clear all preferences?')) {
        localStorage.removeItem('barcodePreferences');
        resetSettings();
        showStatus('Preferences cleared', 'info');
      }
    }

    function resetSettings() {
      if (confirm('Are you sure you want to reset all settings to defaults?')) {
        dataInput.value = '';
        barcodeType.value = 'ean13';
        autoChecksum.checked = true;
        forceNumeric.checked = false;
        showText.checked = true;
        textSize.value = '12';
        widthInput.value = '300';
        heightInput.value = '150';
        scaleInput.value = '2';
        marginInput.value = '10';
        barHeightRatio.value = '80';
        fgColor.value = '#000000';
        bgColor.value = '#ffffff';
        outputFormat.value = 'svg';
        bearerBars.checked = false;
        monochrome.checked = false;
        enforceQuietZone.checked = true;
        dpiSelect.value = '300';
        
        // Update UI
        updateTextSizeValue();
        updateScaleValue();
        updateMarginValue();
        updateBarHeightValue();
        updateColorValues();
        handleBarcodeTypeChange();
        
        // Clear canvas
        barcodeSvg.innerHTML = '';
        
        // Disable buttons
        downloadBtn.disabled = true;
        copyBtn.disabled = true;
        copyDataBtn.disabled = true;
        previewDownloadBtn.disabled = true;
        previewCopyBtn.disabled = true;
        
        // Reset stats
        updateStats('ean13', 300, 150, '');
        scanStatus.className = 'scan-status';
        scanStatus.innerHTML = '<i class="fas fa-info-circle"></i> Generate a barcode to test scannability';
        
        showStatus('Settings reset to defaults', 'info');
      }
    }

    function showStatus(message, type) {
      // Simple status message - could be enhanced with a proper toast system
      console.log(`${type}: ${message}`);
    }

    // ---------- THEME TOGGLE ----------
    const themeToggle = document.getElementById("themeToggle");
    const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");
    
    // Check for saved theme preference or use device preference
    const currentTheme = localStorage.getItem("theme") || 
                        (prefersDarkScheme.matches ? "dark" : "light");
    
    if (currentTheme === "light") {
      document.body.classList.add("light-mode");
    }
    
    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("light-mode");
      
      // Save theme preference
      const theme = document.body.classList.contains("light-mode") ? "light" : "dark";
      localStorage.setItem("theme", theme);
    });

    // Initialize the generator when the page loads
    document.addEventListener('DOMContentLoaded', initializeGenerator);
  </script>
</body>
</html>